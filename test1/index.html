<link rel="stylesheet" href="./style.css"/>
<div class="tabs">
  <input id="tab01" type="radio" name="tab_switch" checked>
  <label class="tab_label" for="tab01">タブ01</label>
  <input id="tab02" type="radio" name="tab_switch">
  <label class="tab_label" for="tab02">タブ02</label>
    
  <div class="tab_content" id="tab01_content">
    <p>タブ01の内容を表示しています。</p>

<h4><strong>Argo CD with GUI</strong></h4>
<h1>Argo CD with GUI</h1>
<p>この章では、Kubernetes上でGitOpsを可能とするCDツールであるArgo CDについて紹介し、導入します。</p>
<h2>GitOpsとCI/CDについて</h2>
<p>CI/CDは、継続的インテグレーション（CI）と継続的デリバリー/デプロイメント（CD）を実現するための手法です。
CIは、アプリケーションのビルド、テスト、およびコードの統合を自動化するプロセス
CDは、アプリケーションのデプロイメントを自動化するプロセスです。
テストやデプロイを自動化することで、オペミスや作業量を減らすことで余ったリソースでアリケーションやソフトウェアの品質を高めたり、リソースサイクルを早めることを目的としている。</p>
<p>GitOpsは、CI/CDを実現するための手法の一つで、Gitのリポジトリの変更をトリガーにCI/CDを実行することで、アプリケーションのデプロイメントを自動化するプロセスです。</p>
<h2>Argo CDについて</h2>
<p>Kubrnetes用のGitOpsツールで、Gitリポジトリに格納されたマニフェストをデプロイすることができます。WEB GUIとCLIの両方で操作することができ、アプリケーションやKuberenetesのリソースの状態を可視化し簡単に管理する事が可能になっています。
ArgoCDはGitHub等からのWebhookを受け取り、Gitリポジトリに格納されたマニフェストをデプロイすることができるため、開発者のコードPushやPRをトリガーにデプロイまで実行することができます。</p>
<h3>Argo CDのアーキテクチャ</h3>
<p><img src="https://argo-cd.readthedocs.io/en/stable/assets/argocd_architecture.png" alt="image" /></p>
<p>Argo CDは三つのコアコンポーネントで構成されています。</p>
<ul>
<li>API Server</li>
<li>Repository Server</li>
<li>Application Controller</li>
</ul>
<h2>OutOfSync/Synced</h2>
<p>アプリケーションがGitリポジトリの定義と設定と一致しているかどうかを示すステータスです。</p>
<h4>OutOfSync</h4>
<p>Gitリポジトリとアプリケーションの状態が一致せず、アプリケーションに変更があったか、同期エラーが発生したことを示します。</p>
<h4>Synced</h4>
<p>Gitリポジトリとアプリケーションの状態が一致し、アプリケーションが期待どおりに機能していることを示します。</p>
<h2>Healthy/Degrated/Processing</h2>
<p>アプリケーションの状態を示す異なるステータスで、アプリケーションの健全性や動作状態を示すステータスです。</p>
<h4>Healthy</h4>
<p>アプリケーションのコンポーネントやサーバーが期待どおりに応答し、エラーや障害がない状態です。</p>
<h4>Degrated</h4>
<p>アプリケーションが完全に停止していないが、一部の問題が存在する状態です。</p>
<h4>Processing</h4>
<p>アプリケーションやサービスが現在、新しいリクエストやデプロイメントなどの操作を処理していることを示し"Healthy" または "Degraded" の状態に変わります。</p>
<h2>Refresh/Hard Refresh/Sync の違いについて</h2>
<p>これらの三つの処理は、GitレポジトリとArgo CDの状態を同期させるための処理ですが細かな違いが存在します。</p>
<h4>Refresh</h4>
<p>最新のGit上のマニフェストとRepository Server内にあるマニフェストを比較し、差分を反映します。
通常の更新はデフォルトで3分ごとに行われます。</p>
<h4>HardRefresh</h4>
<p>HelmやKustomizeなどのコードから生成されたマニフェストをキャッシュしているマニフェストキャッシュをクリアし、新たにRefresh処理を行う操作です。これにより、マニフェストの変更の有無にかかわらず、マニフェストを再生成できます。
デフォルトで24時間ごとに、マニフェストキャッシュの有効期限が切れたときに行われます。</p>
<h4>Sync</h4>
<p>Kubernetes clusterをGitの状態に同期させるため、マニフェストの反映（デプロイ）をします。</p>
<h3>Gitリポジトリの準備(ローカル環境)</h3>
<p>Argo CDを利用する上では、GitHubへのPush等の変更が必要不可欠になります。そのため、このハンズオンのリポジトリをforkして操作する為の準備をします。</p>
<p><a href="https://github.com/cloudnativedaysjp/cndt2023-handson">このハンズオン</a>にアクセスし、forkをクリックします
<img src="image/setup/fork-1.png" alt="fork1" /></p>
<p>Create fork をクリックします
<img src="image/setup/fork-2.png" alt="fork2" /></p>
<p>自身のアカウントでforkされていることが確認できます
<img src="image/setup/fork-3.png" alt="fork2" /></p>
<p>GitHubのリポジトリの登録やPushはforkした自身のリポジトリを利用して下さい</p>
<h3>Argo CDのインストール</h3>
<p>helmファイルを利用してArgo CDをインストールします。</p>
<pre><code>helmfile sync  -f helm/helmfile.yaml
</code></pre>
<p>作成されるリソースは下記の通りです。</p>
<pre><code>kubectl get service,deployment  -n argo-cd
</code></pre>
<pre><code># 実行結果
NAME                                               TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)             AGE
service/argo-cd-argocd-applicationset-controller   ClusterIP   10.96.209.173   &lt;none&gt;        7000/TCP            26d
service/argo-cd-argocd-dex-server                  ClusterIP   10.96.116.27    &lt;none&gt;        5556/TCP,5557/TCP   26d
service/argo-cd-argocd-redis                       ClusterIP   10.96.28.90     &lt;none&gt;        6379/TCP            26d
service/argo-cd-argocd-repo-server                 ClusterIP   10.96.249.188   &lt;none&gt;        8081/TCP            26d
service/argo-cd-argocd-server                      ClusterIP   10.96.152.238   &lt;none&gt;        80/TCP,443/TCP      26d

NAME                                                       READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/argo-cd-argocd-applicationset-controller   1/1     1            1           26d
deployment.apps/argo-cd-argocd-dex-server                  1/1     1            1           26d
deployment.apps/argo-cd-argocd-notifications-controller    1/1     1            1           26d
deployment.apps/argo-cd-argocd-redis                       1/1     1            1           26d
deployment.apps/argo-cd-argocd-repo-server                 1/1     1            1           26d
deployment.apps/argo-cd-argocd-server                      1/1     1            1           26d
</code></pre>
<p>ingressを作成し、Argo CDのWEB UIにアクセス出来るようにします。</p>
<pre><code>kubectl apply -f ingress/ingress.yaml
</code></pre>
<p>http://argocd.vmXX.handson.cloudnativedays.jp/
へアクセスします。下記のページにアクセス出来るか確認して下さい。</p>
<ul>
<li>ユーザ名: admin</li>
<li>パスワード: 以下のコマンドをサーバ上で実行した値<ul>
<li><code>kubectl -n argo-cd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d ; echo</code></li></ul></li>
</ul>
<p><img src="./image/setup/access-webui.png" alt="webui" /></p>
<h3>レポジトリの登録</h3>
<p>同期させるGitのレポジトリを登録します。</p>
<p>Settings - &gt; Repositories と進み CONEECT REPOをクリックします　
<img src="./image/setup/add-repo-setting.png" alt="CONEECT REPO" />
上の画面上で各項目を次のように設定</p>
<pre><code>Choose your connection method: VIA HTTPS
Type: git
Project: default
Repository URL: https://github.com/自身のアカウント名/cndt2023-handson
</code></pre>
<p>CONNECTをクリックして、下記のように表示されていることを確認して下さい。
<img src="./image/setup/add-repo-complete.png" alt="CONNECT" /></p>
<h2>デモアプリのデプロイ</h2>
<p>試しにデモアプリのデプロイを行い、Argo CDの一連の操作を行います。</p>
<p>Argo CDに同期させるGitリポジトリをを準備します。</p>
<pre><code class="bash language-bash">git clone https://github.com/自身のアカウント名/cndt2023-handson.git
</code></pre>
<p>Applicationsの画面において + NEW APPをクリックします<img src="./image/demoapp/new-app.png" alt="Applications" />
上の画面上で各項目を次のように設定します。</p>
<pre><code>GENERAL
  Application Name: argocd-demo
  Project Name: default
  SYNC POLICY: Manual
  SYNC OPTIONS: AUTO CREATE NAMESPACE [v]
  SOURCE
    Repository URL: https://github.com/自身のアカウント名/cndt2023-handson
    Revision: main
    Path: chapter05_argocd/app/default
  DESTINATION
    Cluster URL: https://kubernetes.default.svc
    Namespace: argocd-demo
</code></pre>
<p>設定できたら、CREATEをクリックして、下記のように表示されていることを確認して下さい。
<img src="./image/demoapp/create.png" alt="create" />
<img src="./image/demoapp/create2.png" alt="create2" /></p>
<p>ページ上部にあるSYNCをクリックして、無事デプロイされると下記のように表示されていることを確認して下さい。</p>
<p><img src="./image/demoapp/sync.png" alt="sync" />
ブラウザから
http://app.argocd.vmXX.handson.cloudnativedays.jp
へアクセスして確認してみてください。アプリケーションが表示され青い色のタイルが出てくるのが確認できます。</p>
<p><img src="./image/demoapp/demo-app.png" alt="demo app" /></p>
<p>上記の手順でGitに保存しているマニフェストを参照して、アプリケーションのデプロイを行いました。次にGitの変更にKubernetes Clusterを同期させます。</p>
<p>app/default/deployment.yamlの編集を行います。 imageのtagをblueからgreenに変更します。</p>
<pre><code>image: argoproj/rollouts-demo:green
</code></pre>
<p>差分をforkしたmainブランチ（Argo CDのappを作成する際に指定したブランチ）に取り込みます。</p>
<pre><code>git push origin main
</code></pre>
<p>Argo CDはデフォルトでは3分に一回の頻度でブランチを確認し、差分を検出しています。 3分待てない場合には、ページ上部にある [REFRESH]をクリックします。下記のようにdeploymentにおいて差分が検出されます。（黄色で表示されているOutOfSyncが差分があることを示しています） ちなみにAppの設定において、SYNC POLICYをManualでなくAutoにしていた場合には、ここでOutOfSyncを検知すると自動でArgoCDがSyncを実行します。
<img src="image/demoapp/blue2green.png" alt="blue2green" />
Gitの変更をKubernetes Clusterに反映させるためにページ上部にあるSYNCをクリックして、下記のように表示されていることを確認して下さい。
<img src="image/demoapp/blue2green-sync.png" alt="blue2green" />
http://app.argocd.vmXX.handson.cloudnativedays.jp
へアクセスして確認するとタイルが青から緑に変わったことが確認できます。
<img src="image/demoapp/blue2green-demoapp.png" alt="blue2green" /></p>
<h2>Kustomizeを使ったデプロイ</h2>
<p>ArgoCD上でマニフェストの管理ツールである「Kustomize」を利用した、開発環境と本番環境の2つのマニフェスト管理を行います。</p>
<p>Applicationsの画面において + NEW APPをクリックし、本番環境・開発環境それぞれのアプリケーションを作成します。
<a href="./image/demoapp/new-app.png">Applications</a>
上の画面上で各項目を次のように設定します。(開発環境と本番環境で分けて表示してある項目は、それぞれ設定してください)</p>
<pre><code>GENERAL
  Application Name: 
    開発環境: argocd-kustomize-dev
    本番環境: argocd-kustomize-prd
  Project Name: default
  SYNC POLICY: Manual
  SYNC OPTIONS: AUTO CREATE NAMESPACE [v]
  SOURCE
    Repository URL: https://github.com/自身のアカウント名/cndt2023-handson
    Revision: main
    Path:
      開発環境: chapter05_argocd/app/Kustomize/overlays/dev
      本番環境: chapter05_argocd/app/Kustomize/overlays/prd
  DESTINATION
    Cluster URL: https://kubernetes.default.svc
    Namespace: 
      開発環境: argocd-kustomize-dev
      本番環境: argocd-kustomize-prd
</code></pre>
<p>設定できたら、CREATEをクリックします
<img src="image/demoapp/Kustomize-create.png" alt="Kustomize-create" /></p>
<h3>開発環境</h3>
<p><img src="image/demoapp/Kustomize-create2-dev.png" alt="Kustomize-create" /></p>
<h3>本番環境</h3>
<p><img src="image/demoapp/Kustomize-create2-prd.png" alt="Kustomize-create" />
ページ上部にある SYNCをクリックします(開発環境の場合はpodが1個、本番環境の場合はpodが2個出来るのが確認できます。)</p>
<h3>開発環境</h3>
<p><img src="image/demoapp/Kustomize-sync-dev.png" alt="Kustomize-dev" /></p>
<h3>本番環境</h3>
<p><img src="image/demoapp/Kustomize-sync-prd.png" alt="Kustomize-prd" /></p>
<p>ブラウザで各環境へアクセスして確認してみてください。タイルの色が開発環境と本番環境で違う事が確認できます。</p>
<ul>
<li>開発環境: dev.kustomize.argocd.vmXX.handson.cloudnativedays.jp</li>
<li>本番環境: prd.kustomize.argocd.vmXX.handson.cloudnativedays.jp</li>
</ul>
<h2>Helmを使ったデプロイ</h2>
<p>KubernetesのパッケージマネージャーのHelmを利用したデプロイを行います。</p>
<p>Applicationsの画面において + NEW APPをクリックします
<img src="./image/demoapp/new-app.png" alt="Applications" />
上の画面上で各項目を次のように設定します。</p>
<pre><code>GENERAL
  Application Name: argocd-helm
  Project Name: default
  SYNC POLICY: Manual
  SYNC OPTIONS: AUTO CREATE NAMESPACE [v]
  SOURCE
    Repository URL: https://github.com/自身のアカウント名/cndt2023-handson
    Revision: main
    Path: chapter05_argocd/app/Helm/rollouts-demo
  DESTINATION
    Cluster URL: https://kubernetes.default.svc
    Namespace: argocd-helm
</code></pre>
<p>設定できたら、CREATEをクリックします
<img src="./image/demoapp/helm-create.png" alt="helm-create" />
<img src="./image/demoapp/helm-create2.png" alt="helm-create2" />
ページ上部にある SYNCをクリックします（無事デプロイされると下記のようになります）
<img src="./image/demoapp/helm-sync.png" alt="helm-sync" />
ブラウザで
helm.argocd.vmXX.handson.cloudnativedays.jp
アクセスして確認してみてください。Helmを使ってデプロイが出来ている事が確認できます。</p>
<h2>作成したデモアプリを削除</h2>
<p>各アプリのDELETEをクリックします</p>
<p>Applications画面の場合は、一番右下の端に、
<img src="image/demoapp/Delete-1.png" alt="delete" /></p>
<p>詳細画面の場合は、右上の2番目にあります。
<img src="image/demoapp/Delete-2.png" alt="delete" /></p>
<p>削除する際にアプリケーション名の入力があるので入力してOKをクリックします。
<img src="image/demoapp/Delete-3.png" alt="delete" /></p>
<p>全てのアプリケーションを削除して、初めてアクセスした画面と同じようにして下さい。
<img src="image/setup/access-webui.png" alt="aplication" /></p>
<p>namespaceの削除を行います。</p>
<pre><code>kubectl delete namespace argocd-demo argocd-kustomize-dev argocd-kustomize-prd argocd-helm
</code></pre>
<p><br><br></p>

    
  </div>
  <div class="tab_content" id="tab02_content">
    <p>タブ02の内容を表示しています。</p>
  </div>
</div>
